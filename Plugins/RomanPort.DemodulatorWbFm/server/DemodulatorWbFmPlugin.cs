using System;
using RaptorSDR.Server.Common;
using RomanPort.ViewSpectrum.API;

namespace RomanPort.DemodulatorWbFm
{
    public unsafe partial class DemodulatorWbFmPlugin : RaptorPlugin
    {
        private WebDemodulator demod;
        
        public DemodulatorWbFmPlugin(IRaptorControl control) : base(control)
        {
            demod = new WebDemodulator(this, "WbFm");
            RegisterDemodulator(demod);
        }
        
        public override void Init()
        {
            //Register FFT for MPX
            if (Control.GetPluginInterface<ISpectrumProvider>(out ISpectrumProvider provider))
            {
                //Add the spectrum
                IRegisteredSpectrumReal spectrum = provider.RegisterSpectrumReal(Id.Then("SpectrumMPX"), new SpectrumSettings
                {
                    fftSize = 16384,
                    name = "MPX Spectrum",
                    fixedIncrement = 19000,
                    dummySpectrum = DUMMY_SPECTRUM
                });

                //Map it
                demod.OnMpxSampleRateChanged += spectrum.SetSampleRate;
                demod.OnMpxSamplesEmitted += spectrum.AddSamples;
            }
        }

        private static readonly byte[] DUMMY_SPECTRUM = new byte[]
        {
            88, 91, 105, 92, 108, 89, 98, 91, 97, 111, 113, 98, 103, 98, 104, 95, 98, 106, 129, 96, 96, 112, 100, 106, 97, 100, 119, 113, 121, 123, 117, 114, 113, 111, 107, 115, 114, 120, 110, 109, 106, 100, 100, 100, 98, 108, 103, 97, 88, 99, 101, 97, 101, 102, 100, 104, 95, 96, 95, 109, 106, 110, 111, 105, 104, 103, 98, 97, 106, 124, 115, 110, 110, 112, 109, 100, 95, 99, 107, 118, 109, 113, 116, 119, 121, 111, 107, 110, 119, 122, 133, 139, 183, 193, 194, 207, 201, 216, 221, 221, 223, 221, 213, 220, 219, 212, 209, 216, 212, 215, 208, 213, 101, 92, 202, 213, 213, 213, 206, 209, 214, 210, 218, 215, 213, 213, 213, 207, 210, 183, 171, 164, 166, 149, 148, 148, 144, 143, 138, 142, 141, 149, 144, 135, 136, 146, 139, 142, 140, 132, 128, 140, 133, 137, 134, 133, 131, 131, 125, 138, 125, 132, 130, 128, 129, 142, 142, 135, 131, 111, 132, 128, 128, 132, 122, 133, 123, 119, 129, 137, 127, 129, 137, 157, 139, 129, 137, 133, 132, 132, 147, 140, 141, 140, 142, 145, 153, 158, 144, 144, 135, 125, 126, 120, 130,
            126, 126, 146, 136, 138, 135, 124, 123, 137, 122, 140, 134, 142, 136, 119, 120, 124, 129, 132, 135, 130, 145, 146, 133, 136, 136, 131, 138, 120, 122, 130, 144, 139, 135, 124, 136, 122, 125, 138, 132, 134, 135, 125, 124, 128, 120, 134, 125, 133, 148, 153, 155, 148, 151, 142, 139, 142, 145, 145, 135, 143, 140, 137, 135, 131, 150, 149, 128, 136, 132, 130, 125, 124, 137, 124, 132, 136, 133, 137, 114, 123, 139, 147, 149, 136, 137, 132, 130, 131, 137, 133, 134, 138, 135, 134, 137, 148, 140, 129, 130, 140, 151, 145, 149, 152, 140, 151, 158, 148, 149, 152, 147, 155, 155, 163, 161, 166, 163, 169, 174, 208, 209, 197, 191, 178, 169, 172, 153, 157, 159, 150, 161, 161, 163, 177, 190, 194, 173, 172, 159, 159, 154, 150, 158, 156, 166, 168, 176, 194, 199, 207, 208, 213, 200, 202, 202, 203, 203, 211, 218, 208, 204, 210, 204, 206, 209, 203, 204, 211, 210, 204, 206, 205, 201, 206, 205, 202, 201, 202, 206, 198, 208, 208, 206, 208, 203, 212, 199, 197, 199, 202, 199, 211, 212, 203, 204, 214, 200, 206, 202,
            197, 206, 198, 211, 214, 222, 205, 203, 202, 208, 206, 198, 201, 199, 204, 208, 202, 205, 199, 203, 203, 196, 199, 206, 198, 195, 199, 203, 205, 205, 197, 209, 199, 194, 195, 195, 204, 198, 196, 204, 206, 208, 201, 197, 199, 206, 200, 196, 204, 196, 183, 204, 205, 205, 203, 197, 198, 198, 189, 202, 201, 195, 205, 202, 209, 205, 190, 201, 198, 192, 197, 206, 214, 192, 193, 197, 201, 195, 188, 200, 195, 197, 195, 201, 194, 207, 195, 195, 198, 191, 197, 193, 198, 198, 204, 205, 199, 198, 197, 195, 203, 197, 190, 190, 189, 197, 200, 195, 193, 197, 197, 203, 201, 191, 191, 191, 193, 191, 200, 199, 194, 192, 208, 207, 198, 193, 194, 192, 188, 194, 207, 196, 202, 201, 195, 201, 201, 200, 206, 208, 205, 199, 198, 200, 206, 199, 203, 211, 215, 200, 204, 204, 191, 194, 203, 190, 195, 190, 194, 195, 194, 197, 194, 195, 187, 203, 194, 199, 204, 195, 200, 207, 201, 197, 198, 199, 190, 192, 198
        };
    }
}