using System;
using System.Collections.Generic;
using RaptorSDR.Server.Common;
using RaptorSDR.Server.Common.DataProviders;
using RomanPort.ViewSpectrum.API;
using RomanPort.ViewSpectrum.Spectrums;

namespace RomanPort.ViewSpectrum
{
    public unsafe partial class ViewSpectrumPlugin : RaptorPlugin, ISpectrumProvider
    {
        private List<RegisteredSpectrumEntry> spectrums = new List<RegisteredSpectrumEntry>();
        private RaptorPrimitiveDataProvider<List<RegisteredSpectrumEntry>> dpSpectrums;
        private IRegisteredSpectrumComplex mainSpectrum;
        
        public ViewSpectrumPlugin(IRaptorControl control) : base(control)
        {
            //Create data provider
            dpSpectrums = new RaptorPrimitiveDataProvider<List<RegisteredSpectrumEntry>>(this, "Spectrums")
                .SetWebReadOnly(true);
            dpSpectrums.Value = spectrums;
            
            //Register built-in main FFT
            mainSpectrum = RegisterSpectrumComplex(Id.Then("MainFFT"), new SpectrumSettings
            {
                name = "Main Spectrum",
                fftSize = 32768,
                defaultOffset = 20,
                defaultRange = 80,
                freqDataProvider = "RaptorSDR.Radio.CenterFreq",
                dummySpectrum = DUMMY_MAIN
            });
            control.Radio.OnConfigured += (IRaptorRadio radio) => mainSpectrum.SampleRate = (int)radio.SampleRate;
            control.Radio.OnSamples += mainSpectrum.AddSamples;

            //Register ourselves as an interface so other plugins can add their own FFTs
            control.RegisterPluginInterface<ISpectrumProvider>(this);
        }
        
        public IRegisteredSpectrumComplex RegisterSpectrumComplex(RaptorNamespace id, SpectrumSettings settings)
        {
            var spectrum = new ComplexRegisteredSpectrum(Control, id, settings);
            spectrums.Add(new RegisteredSpectrumEntry(spectrum));
            return spectrum;
        }

        public IRegisteredSpectrumReal RegisterSpectrumReal(RaptorNamespace id, SpectrumSettings settings)
        {
            var spectrum = new RealRegisteredSpectrum(Control, id, settings);
            spectrums.Add(new RegisteredSpectrumEntry(spectrum));
            return spectrum;
        }

        public override void Init()
        {
            
        }

        private static readonly byte[] DUMMY_MAIN = new byte[]
        {
            232, 231, 236, 234, 233, 227, 233, 232, 233, 229, 232, 238, 231, 233, 225, 230, 231, 231, 234, 232, 235, 236, 229, 230, 235, 227, 233, 231, 231, 229, 233, 230, 234, 230, 230, 232, 236, 231, 230, 228, 233, 236, 231, 234, 232, 232, 234, 234, 236, 228, 235, 239, 232, 234, 230, 230, 238, 225, 232, 234, 231, 231, 226, 233, 233, 240, 232, 235, 236, 231, 230, 231, 230, 231, 227, 235, 233, 233, 235, 232, 234, 228, 232, 228, 235, 230, 229, 231, 224, 228, 228, 229, 227, 230, 227, 235, 226, 228, 234, 223, 229, 223, 227, 225, 226, 226, 228, 227, 227, 225, 231, 228, 225, 229, 227, 234, 224, 226, 226, 226, 229, 226, 230, 229, 226, 228, 227, 229, 227, 230, 227, 229,
            227, 228, 225, 226, 229, 224, 219, 229, 222, 223, 219, 228, 225, 226, 222, 226, 220, 225, 223, 220, 225, 213, 213, 206, 193, 189, 182, 168, 129, 114, 112, 114, 117, 112, 113, 117, 110, 113, 113, 111, 112, 111, 112, 114, 111, 111, 116, 111, 116, 113, 116, 109, 112, 112, 113, 114, 115, 111, 112, 112, 111, 114, 112, 111, 111, 116, 113, 110, 111, 118, 117, 112, 117, 111, 114, 114, 114, 114, 109, 114, 114, 113, 113, 112, 120, 112, 113, 112, 115, 108, 115, 113, 119, 110, 112, 110, 111, 112, 113, 112, 114, 110, 110, 113, 109, 112, 113, 117, 110, 114, 110, 110, 111, 108, 109, 108, 110, 110, 111, 113, 109, 110, 109, 114, 110, 113, 110, 109, 115, 111, 111, 108,
            114, 109, 113, 108, 111, 113, 148, 156, 159, 154, 158, 153, 154, 160, 154, 148, 153, 154, 151, 151, 150, 148, 145, 145, 143, 143, 146, 138, 136, 137, 137, 140, 138, 135, 138, 138, 139, 128, 131, 123, 130, 126, 134, 130, 124, 125, 125, 119, 127, 130, 125, 122, 121, 123, 118, 116, 120, 116, 115, 113, 114, 110, 111, 110, 103, 102, 99, 104, 105, 97, 102, 98, 99, 97, 96, 95, 95, 91, 89, 84, 86, 86, 81, 86, 84, 86, 77, 78, 81, 76, 73, 73, 77, 75, 70, 77, 72, 73, 67, 69, 71, 72, 73, 76, 70, 69, 73, 67, 67, 67, 71, 70, 70, 73, 66, 66, 72, 66, 69, 69, 71, 66, 70, 65, 73, 67, 69, 61, 69, 61, 63, 61, 65, 63, 61, 63, 68, 60, 66, 61, 62, 65, 56, 56, 60, 67, 58, 65,
            65, 64, 58, 65, 66, 61, 62, 59, 60, 53, 50, 64, 58, 58, 53, 55, 52, 58, 58, 56, 58, 53, 59, 54, 58, 53, 60, 57, 51, 60, 52, 59, 53, 48, 55, 54, 56, 52, 55, 49, 49, 57, 48, 58, 53, 56, 59, 54, 54, 54, 52, 58, 50, 51, 58, 51, 48, 49, 50, 51, 52, 51, 52, 53, 53, 56, 59, 56, 51, 52, 45, 55, 56, 54, 54, 53, 57, 51, 53, 55, 57, 53, 55, 54, 57, 51, 55, 52, 58, 50, 54, 52, 56, 51, 53, 51, 58, 48, 51, 53, 50, 59, 52, 58, 54, 53, 58, 57, 54, 62, 54, 56, 55, 59, 56, 53, 59, 57, 56, 61, 59, 57, 53, 55, 60, 55, 58, 53, 62, 60, 65, 58, 59, 62, 61, 61, 60, 62, 63, 64, 60, 64, 61, 65, 65, 64, 63, 66, 69, 63, 62, 70, 69, 71, 65, 66, 67, 68, 71, 70, 69, 71, 70, 74, 68,
            68, 69, 70, 72, 70, 66, 70, 70, 74, 74, 73, 76, 74, 77, 76, 73, 78, 78, 81, 85, 80, 86, 85, 87, 85, 89, 89, 89, 95, 90, 98, 101, 94, 100, 98, 103, 106, 102, 104, 102, 105, 103, 113, 108, 111, 114, 115, 121, 114, 116, 122, 116, 121, 121, 127, 119, 122, 123, 123, 127, 131, 129, 131, 128, 131, 134, 133, 134, 138, 135, 141, 139, 140, 141, 140, 142, 141, 147, 143, 144, 147, 151, 146, 149, 146, 145, 146, 158, 151, 153, 152, 151, 153, 158, 160, 154, 154, 150, 118, 104, 113, 111, 105, 108, 111, 108, 105, 107, 111, 109, 109, 106, 106, 107, 109, 112, 105, 110, 108, 109, 106, 106, 106, 109, 107, 113, 109, 105, 108, 107, 107, 103, 106, 107, 113, 106, 103, 106, 110,
            108, 108, 106, 107, 104, 110, 108, 108, 111, 110, 107, 108, 110, 110, 107, 110, 105, 106, 109, 110, 108, 107, 109, 107, 107, 109, 108, 108, 110, 106, 109, 106, 104, 112, 109, 108, 109, 105, 108, 105, 105, 109, 103, 105, 106, 109, 106, 106, 105, 112, 105, 107, 109, 110, 106, 109, 111, 110, 111, 111, 105, 104, 105, 109, 112, 108, 111, 110, 116, 166, 173, 185, 191, 200, 203, 209, 211, 218, 218, 219, 219, 221, 223, 223, 223, 226, 227, 228, 223, 221, 228, 222, 225, 235, 226, 227, 230, 227, 226, 228, 227, 228, 228, 224, 226, 228, 230, 232, 228, 225, 224, 230, 228, 228, 227, 230, 230, 229, 227, 227, 228, 226, 228, 230, 233, 229, 228, 228, 224, 228, 227, 231,
            228, 221, 228, 226, 231, 226, 229, 231, 235, 229, 235, 231, 233, 231, 236, 230, 226, 232, 232, 228, 232, 226, 233, 231, 235, 227, 228, 223, 229, 235, 231, 231, 228, 231, 238, 229, 232, 238, 233, 230, 231, 232, 232, 230, 236, 228, 229, 230, 225, 230, 238, 234, 231, 228, 229, 237, 233, 231, 230, 230, 233, 229, 228, 226, 225, 225, 229, 226, 233, 231, 232, 233, 232, 231, 233, 228, 227, 234, 233, 231, 234, 233, 233, 231, 234, 230, 231, 231, 231, 231, 231, 236, 238
        };
    }
}